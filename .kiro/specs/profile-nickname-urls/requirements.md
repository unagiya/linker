# 要件定義書

## はじめに

プロフィールニックネームURL機能は、既存のLinkerプラットフォームに追加される機能です。この機能により、ユーザーは覚えやすいニックネームを設定し、そのニックネームを使用したカスタムURLでプロフィールにアクセスできるようになります。従来のUUID形式のURLに加えて、`/profile/john-doe`のような人間が読みやすいURLを提供します。

## 用語集

- **Nickname**: ユーザーが設定するURL用の一意の識別子（英数字とハイフンのみ）
- **Nickname URL**: ニックネームを使用したプロフィールURL（例：`/profile/john-doe`）
- **UUID URL**: 従来のUUID形式のプロフィールURL（例：`/profile/123e4567-e89b-12d3-a456-426614174000`）
- **Nickname Validation**: ニックネームの形式とユニーク性をチェックする処理
- **URL Slug**: URLで使用可能な形式に変換された文字列
- **Nickname Availability**: ニックネームが使用可能かどうかの状態

## 要件

### 要件 1: ユーザー登録時のニックネーム設定

**ユーザーストーリー:** エンジニアとして、アカウント登録時にニックネームを設定したいので、覚えやすいURLでプロフィールを共有できるようにしたい。

#### 受け入れ基準

1. WHEN ユーザーがアカウント登録ページにアクセスする THEN Linker SHALL メールアドレス、パスワード、ニックネームの入力フィールドを表示する
2. WHEN ユーザーがニックネームを入力する THEN Linker SHALL リアルタイムでニックネームの利用可能性をチェックする
3. WHEN ユーザーが既に使用されているニックネームを入力する THEN Linker SHALL 「このニックネームは既に使用されています」というエラーメッセージを表示する
4. WHEN ユーザーが無効な形式のニックネームを入力する THEN Linker SHALL 「ニックネームは3-36文字の英数字、ハイフン、アンダースコアのみ使用可能です」というエラーメッセージを表示する
5. WHEN ユーザーが有効で利用可能なニックネームを入力する THEN Linker SHALL 「このニックネームは利用可能です」という確認メッセージを表示する
6. WHEN アカウント登録が完了する THEN Linker SHALL ニックネームをプロフィールに関連付けて保存する

### 要件 2: ニックネームバリデーション

**ユーザーストーリー:** エンジニアとして、適切なニックネームを設定したいので、明確なルールに従ってニックネームを作成できるようにしたい。

#### 受け入れ基準

1. WHEN ユーザーがニックネームを入力する THEN Linker SHALL 3文字以上36文字以下であることを検証する
2. WHEN ユーザーがニックネームを入力する THEN Linker SHALL 英数字（a-z、A-Z、0-9）、ハイフン（-）、アンダースコア（_）のみを受け付ける
3. WHEN ユーザーがニックネームを入力する THEN Linker SHALL 記号（ハイフン、アンダースコア）で始まったり終わったりしないことを検証する
4. WHEN ユーザーがニックネームを入力する THEN Linker SHALL 連続する記号（ハイフン、アンダースコア）を含まないことを検証する
5. WHEN ユーザーがニックネームを入力する THEN Linker SHALL 大文字小文字を区別せずにユニーク性をチェックする
6. WHEN ユーザーがニックネームを入力する THEN Linker SHALL 予約語（admin、api、www、profile、signin、signup等）を使用できないようにする

### 要件 3: ニックネームベースURL

**ユーザーストーリー:** エンジニアとして、ニックネームを使用したURLでプロフィールにアクセスしたいので、覚えやすく共有しやすいURLを使用できるようにしたい。

#### 受け入れ基準

1. WHEN ユーザーがニックネームベースURL（`/profile/nickname`）にアクセスする THEN Linker SHALL 対応するプロフィールを表示する
2. WHEN ユーザーが存在しないニックネームのURLにアクセスする THEN Linker SHALL 404エラーページを表示する
3. WHEN プロフィール所有者がプロフィールページを表示する THEN Linker SHALL ニックネームベースURLを共有URLとして提供する
4. WHEN ユーザーが従来のUUID形式URLにアクセスする THEN Linker SHALL ニックネームベースURLにリダイレクトする
5. WHEN プロフィール編集ページや削除確認ページにアクセスする THEN Linker SHALL ニックネームベースURLを使用する（`/profile/nickname/edit`）
6. WHEN 従来のUUID形式URL（`/profile/{uuid}`）にアクセスされる THEN Linker SHALL 404エラーを返す（UUID形式URLは廃止）

### 要件 4: プロフィール編集でのニックネーム変更

**ユーザーストーリー:** エンジニアとして、プロフィール編集画面でニックネームを変更したいので、必要に応じてURLを更新できるようにしたい。

#### 受け入れ基準

1. WHEN ユーザーがプロフィール編集ページにアクセスする THEN Linker SHALL 現在のニックネームが入力されたニックネーム編集フィールドを表示する
2. WHEN ユーザーがニックネームを変更する THEN Linker SHALL リアルタイムで新しいニックネームの利用可能性をチェックする
3. WHEN ユーザーが既に使用されているニックネームに変更しようとする THEN Linker SHALL エラーメッセージを表示して変更を防止する
4. WHEN ユーザーが有効で利用可能なニックネームに変更する THEN Linker SHALL 変更を保存してSupabaseデータベースを更新する
5. WHEN ニックネーム変更が成功する THEN Linker SHALL 新しいニックネームベースURLにリダイレクトする
6. WHEN ユーザーが古いニックネームのURLにアクセスする THEN Linker SHALL 新しいニックネームのURLにリダイレクトする

### 要件 5: ニックネーム利用可能性チェック

**ユーザーストーリー:** エンジニアとして、ニックネームが利用可能かどうかを即座に知りたいので、入力中にリアルタイムでフィードバックを受けられるようにしたい。

#### 受け入れ基準

1. WHEN ユーザーがニックネーム入力フィールドに文字を入力する THEN Linker SHALL 500ms後に利用可能性チェックを実行する
2. WHEN ニックネームが利用可能である THEN Linker SHALL 緑色のチェックマークと「利用可能です」メッセージを表示する
3. WHEN ニックネームが既に使用されている THEN Linker SHALL 赤色のXマークと「既に使用されています」メッセージを表示する
4. WHEN ニックネームの形式が無効である THEN Linker SHALL 赤色のXマークと具体的なエラーメッセージを表示する
5. WHEN 利用可能性チェック中である THEN Linker SHALL ローディングインジケーターを表示する
6. WHEN ネットワークエラーが発生する THEN Linker SHALL エラーメッセージを表示してユーザーに再試行を促す

### 要件 6: データベーススキーマ更新

**ユーザーストーリー:** システム管理者として、ニックネーム機能をサポートするデータベース構造を持ちたいので、適切なスキーマ設計でデータの整合性を保てるようにしたい。

#### 受け入れ基準

1. WHEN profilesテーブルが更新される THEN Linker SHALL nicknameカラム（TEXT、UNIQUE、NOT NULL）を追加する
2. WHEN nicknameカラムが作成される THEN Linker SHALL 大文字小文字を区別しないユニーク制約を設定する
3. WHEN 既存のプロフィールが存在する THEN Linker SHALL 既存プロフィールにUUIDベースのニックネームを自動設定する
4. WHEN ニックネームが更新される THEN Linker SHALL updated_atカラムも自動更新する
5. WHEN データベースにアクセスする THEN Linker SHALL Row Level Security (RLS)ポリシーがニックネーム機能でも適切に動作する

### 要件 7: 既存ユーザーのマイグレーション

**ユーザーストーリー:** 既存ユーザーとして、ニックネーム機能追加後も自分のプロフィールにアクセスできることを期待するので、適切なマイグレーション処理でスムーズに移行できるようにしたい。

#### 受け入れ基準

1. WHEN ニックネーム機能がデプロイされる THEN Linker SHALL 既存のすべてのプロフィールに自動的にUUIDベースのニックネームを設定する
2. WHEN 既存ユーザーがプロフィール編集ページにアクセスする THEN Linker SHALL 現在のニックネーム（UUID）を表示してカスタマイズ可能にする
3. WHEN マイグレーション処理が実行される THEN Linker SHALL すべての既存プロフィールが新しいニックネームベースURLでアクセス可能になる
4. WHEN UUID形式のニックネームが設定される THEN Linker SHALL ユーザーに「ニックネームをカスタマイズできます」という通知を表示する

### 要件 8: SEOとアクセシビリティ

**ユーザーストーリー:** エンジニアとして、プロフィールが検索エンジンで見つけやすくなることを期待するので、SEOに適したURLとメタデータを持てるようにしたい。

#### 受け入れ基準

1. WHEN ニックネームベースURLが表示される THEN Linker SHALL 適切なページタイトル（「{名前} | Linker」）を設定する
2. WHEN プロフィールページが読み込まれる THEN Linker SHALL メタディスクリプションにプロフィール情報を含める
3. WHEN ニックネームベースURLが共有される THEN Linker SHALL Open Graphメタタグを適切に設定する
4. WHEN 検索エンジンがページをクロールする THEN Linker SHALL 構造化データ（JSON-LD）でプロフィール情報を提供する

### 要件 9: エラーハンドリングとユーザビリティ

**ユーザーストーリー:** エンジニアとして、ニックネーム機能でエラーが発生した場合に適切なフィードバックを受けたいので、問題を理解して対処できるようにしたい。

#### 受け入れ基準

1. WHEN ニックネーム利用可能性チェックでネットワークエラーが発生する THEN Linker SHALL 「接続エラーが発生しました。再試行してください」というメッセージを表示する
2. WHEN ニックネーム変更でデータベースエラーが発生する THEN Linker SHALL 「変更の保存に失敗しました。しばらく待ってから再試行してください」というメッセージを表示する
3. WHEN 無効なニックネームでアクセスされる THEN Linker SHALL 404ページに「プロフィールが見つかりません」というメッセージを表示する
4. WHEN ニックネーム入力フィールドにフォーカスが当たる THEN Linker SHALL ニックネームのルールを説明するヘルプテキストを表示する
5. WHEN ユーザーがニックネーム変更を保存する THEN Linker SHALL 「ニックネームが正常に更新されました」という成功メッセージを表示する

### 要件 10: パフォーマンスとセキュリティ

**ユーザーストーリー:** システム利用者として、ニックネーム機能が高速で安全に動作することを期待するので、パフォーマンスとセキュリティが適切に考慮されるようにしたい。

#### 受け入れ基準

1. WHEN ニックネーム利用可能性チェックが実行される THEN Linker SHALL レスポンス時間を200ms以内に抑える
2. WHEN ニックネームベースURLでプロフィールを検索する THEN Linker SHALL データベースインデックスを使用して高速検索を実現する
3. WHEN ニックネーム入力でSQLインジェクション攻撃が試行される THEN Linker SHALL パラメータ化クエリで攻撃を防止する
4. WHEN 大量のニックネーム利用可能性チェックが短時間で実行される THEN Linker SHALL レート制限を適用してサーバー負荷を制御する
5. WHEN ニックネームが変更される THEN Linker SHALL 古いニックネームのキャッシュを適切に無効化する